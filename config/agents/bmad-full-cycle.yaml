# BMAD Full Cycle Workflow
# Julep Workflow Definition with State Management
# Brief → Model → Act → Deploy

name: bmad-full-cycle
description: |
  Complete BMAD workflow orchestrating all 4 agents through 
  the full development lifecycle with phase gates and state persistence.

version: "1.0"
triggers:
  - "@keisha start brief for"
  - "/bmad"
  - "/new-feature"

# State persists across steps
state:
  phase: "BRIEF"  # BRIEF | MODEL | ACT | DEPLOY | COMPLETE
  feature_name: ""
  prd_approved: false
  architecture_approved: false
  tests_passing: false
  review_approved: false
  blockers: []
  handoff_history: []

# Phase gate definitions
phases:
  BRIEF:
    owner: "@keisha"
    entry_condition: null
    exit_condition: "state.prd_approved == true"
    outputs:
      - prd.md
      - tasklist.md
    cannot_exit_until: "CEO/user explicitly approves brief"
    
  MODEL:
    owner: "@keisha"
    entry_condition: "state.prd_approved == true"
    exit_condition: "state.architecture_approved == true"
    outputs:
      - architecture.md
      - design_decisions.md
    cannot_exit_until: "architecture passes review"
    
  ACT:
    owner: "@ox"
    entry_condition: "state.architecture_approved == true"
    exit_condition: "state.tests_passing == true"
    outputs:
      - implementation/*
      - tests/*
    cannot_exit_until: "all acceptance criteria pass"
    
  DEPLOY:
    owner: "@soulja"
    entry_condition: "state.tests_passing == true"
    exit_condition: "state.review_approved == true"
    outputs:
      - validation_report.md
    cannot_exit_until: "@dmx approves for production"

# Workflow steps
steps:
  # ====== BRIEF PHASE ======
  - id: start_brief
    agent: keisha
    action: |
      Start the BRIEF phase for {{ feature_name }}.
      
      Produce:
      1. PRD with acceptance criteria
      2. Task breakdown with estimates
      3. Risk assessment
      4. Open questions for clarification
      
      Ask clarifying questions before proceeding.
    update_state:
      phase: "BRIEF"
      feature_name: "{{ input.feature_name }}"
    on_complete: await_brief_approval
    
  - id: await_brief_approval
    type: human_input
    prompt: |
      BRIEF Phase Complete.
      
      PRD and TASKLIST ready for review.
      Reply with:
      - "approved" to proceed to MODEL
      - "changes: [feedback]" for revisions
    on_approved:
      update_state:
        prd_approved: true
      next: start_model
    on_changes:
      next: revise_brief
      
  - id: revise_brief
    agent: keisha
    action: |
      Revise the PRD based on feedback:
      {{ feedback }}
    next: await_brief_approval

  # ====== MODEL PHASE ======
  - id: start_model
    agent: keisha
    condition: "state.prd_approved == true"
    action: |
      Start the MODEL phase.
      
      Produce:
      1. Architecture design
      2. Data model (if applicable)
      3. API contracts (if applicable)
      4. Integration points
      5. Decision table for trade-offs
    update_state:
      phase: "MODEL"
      handoff_history: "{{ state.handoff_history + ['BRIEF -> MODEL'] }}"
    on_complete: await_model_approval
    
  - id: await_model_approval
    type: human_input
    prompt: |
      MODEL Phase Complete.
      
      Architecture and design ready for review.
      Reply with:
      - "approved" to proceed to ACT
      - "changes: [feedback]" for revisions
    on_approved:
      update_state:
        architecture_approved: true
      next: start_act
    on_changes:
      next: revise_model

  # ====== ACT PHASE ======
  - id: start_act
    agent: ox
    condition: "state.architecture_approved == true"
    action: |
      Begin implementation of {{ feature_name }}.
      
      Follow the approved PRD and architecture.
      
      1. Write tests first (TDD)
      2. Implement feature
      3. Run all tests
      4. Provide coverage report
      5. Hand off to @soulja for validation
    update_state:
      phase: "ACT"
      handoff_history: "{{ state.handoff_history + ['MODEL -> ACT (@ox)'] }}"
    on_complete: validate_implementation
    
  - id: validate_implementation
    agent: soulja
    action: |
      Run 7-layer validation on {{ feature_name }}:
      
      1. Syntax & Compilation
      2. Unit Tests
      3. Integration Tests
      4. Security Scan
      5. Performance Check
      6. E2E Tests
      7. Chaos Testing (if applicable)
      
      Report PASS or BLOCKED with details.
    on_pass:
      update_state:
        tests_passing: true
      next: start_deploy
    on_blocked:
      next: fix_implementation
      
  - id: fix_implementation
    agent: ox
    action: |
      Fix validation failures:
      {{ validation_report }}
    next: validate_implementation

  # ====== DEPLOY PHASE ======
  - id: start_deploy
    agent: dmx
    condition: "state.tests_passing == true"
    action: |
      Final review for {{ feature_name }}.
      
      1. Architecture compliance
      2. Code quality
      3. Security review
      4. Test coverage
      
      Verdict: APPROVED | CHANGES REQUESTED | BLOCKED
    update_state:
      phase: "DEPLOY"
      handoff_history: "{{ state.handoff_history + ['ACT -> DEPLOY (@dmx)'] }}"
    on_approved:
      update_state:
        review_approved: true
        phase: "COMPLETE"
      next: complete_workflow
    on_changes:
      next: address_review_feedback
    on_blocked:
      next: escalate_blocker
      
  - id: complete_workflow
    type: notification
    message: |
      ✅ BMAD Cycle Complete for {{ feature_name }}!
      
      Phase History: {{ state.handoff_history }}
      
      Ready to merge and deploy.

# Error recovery
error_handlers:
  - condition: "agent_timeout"
    action: |
      Agent {{ current_agent }} timed out in phase {{ state.phase }}.
      Escalating to human.
    escalate: true
    
  - condition: "validation_failed_3x"
    action: |
      Validation failed 3 times. Requesting human intervention.
    escalate: true

# Emergency exit
emergency_exit:
  trigger: "@dismiss --force"
  action: |
    Emergency exit requested.
    Saving state: {{ state }}
    Current phase: {{ state.phase }}
